<!DOCTYPE html>
<html>
<head>
    <title>Impostor Game</title>
    <style>
        button { margin: 5px; }
        #topRight { position: fixed; top: 10px; right: 10px; }
    </style>
</head>
<body>

<h2 id="title">Waiting for host…</h2>

<div id="topRight"></div>

<div id="hostLogin">
    <input id="hostPass" type="password" placeholder="Host password">
    <button onclick="hostLogin()">Login as Host</button>
</div>

<div id="joinArea" style="display:none">
    <input id="name" placeholder="Your name">
    <button onclick="join()">Join</button>
</div>

<ul id="players"></ul>

<button id="startGame" style="display:none" onclick="startGame()">Start Game</button>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
const BACKEND_URL = location.hostname === "localhost"
    ? "http://localhost:5001"
    : "https://imposter-backend-ch3h.onrender.com";

let hostToken = localStorage.getItem("hostToken");
let playerId = localStorage.getItem("playerId");

const socket = io(BACKEND_URL, {
    query: {
        token: hostToken,
        playerId: playerId
    }
});

let isHost = false;
let hasJoined = false;

socket.on("identity_update", data => {
    isHost = data.isHost;
    hasJoined = data.hasJoined;

    if (hasJoined) {
        document.getElementById("joinArea").style.display = "none";
    }
});

function renderPlayers(players) {
    const ul = document.getElementById("players");
    ul.innerHTML = "";
    players.forEach(p => {
        const li = document.createElement("li");
        li.textContent = p.name;
        ul.appendChild(li);
    });
}

function hostLogin() {
    socket.emit("host_login", { password: document.getElementById("hostPass").value });
}

function join() {
    if (hasJoined) return;

    const name = document.getElementById("name").value.trim();
    if (!name) return;

    socket.emit("join", { name, playerId });
}

function leave() {
    localStorage.removeItem("playerId");
    hasJoined = false;
    socket.emit("leave");
    location.reload();
}

function startGame() {
    socket.emit("start_game");
}

socket.on("host_login_result", data => {
    if (!data.success) return alert("Host login failed");

    localStorage.setItem("hostToken", data.token);
    location.reload();
});

socket.on("join_result", data => {
    if (!data.success) return;

    hasJoined = true;
    localStorage.setItem("playerId", data.playerId);

    document.getElementById("name").value = "";
    document.getElementById("joinArea").style.display = "none";
    // Only update topRight to show Leave button if NOT host
    if (!isHost) {
        const top = document.getElementById("topRight");
        top.innerHTML = "<button onclick='leave()'>Leave</button>";
    }

    // Host re-joining after reset must re-show Start Game
    if (isHost) {
        document.getElementById("startGame").style.display = "block";
    }
});

socket.on("state_update", data => {
    if (!data.hostExists) {
        localStorage.removeItem("playerId");
        localStorage.removeItem("hostToken");
        hasJoined = false;
        // Clear players list
        document.getElementById("players").innerHTML = "";
        // Hide start game button
        document.getElementById("startGame").style.display = "none";
        // Clear topRight explicitly when no host exists
        document.getElementById("topRight").innerHTML = "";
    }

    const hostLogin = document.getElementById("hostLogin");
    const joinArea = document.getElementById("joinArea");
    const startBtn = document.getElementById("startGame");
    const title = document.getElementById("title");
    const top = document.getElementById("topRight");

    title.textContent =
        data.state === "waiting" ? "Waiting for host…" :
        data.state === "lobby" ? "Lobby" : "Game Started";

    // Host login
    hostLogin.style.display =
        data.hostExists ? "none" : "block";

    // Name entry:
    // - visible for ALL clients once host exists
    // - hidden after that client has joined
    if (data.hostExists && !hasJoined) {
        joinArea.style.display = "block";
    } else {
        joinArea.style.display = "none";
    }

    // Start game
    startBtn.style.display =
        (isHost && hasJoined && data.state === "lobby") ? "block" : "none";

    // Top-right controls
    if (data.hostExists) {
        top.innerHTML = "";
        if (isHost) {
            top.innerHTML = "<b>Host</b> <button onclick='socket.emit(\"end_session\")'>End Session</button>";
        } else if (hasJoined) {
            top.innerHTML = "<button onclick='leave()'>Leave</button>";
        }
    }
});

socket.on("players_update", data => {
    renderPlayers(data.players);
});
</script>
</body>
</html>