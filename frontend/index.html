<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Impostor Game</title>
    <style>
        #lobby, #waiting, #game { 
            display: none;
        }
        #players li {
            margin-bottom: 4px;
        }
        button {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>Impostor Game</h1>
    <div id="login">
        <h3 id="loginMessage">Waiting for host…</h3>
        <input id="name" placeholder="Enter your name" autocomplete="off" style="display:none" />
        <button id="join" style="display:none">Join</button>
    </div>

    <div id="lobby">
        <h3>Lobby</h3>
        <ul id="players"></ul>
        <button id="leaveLobby">Leave Lobby</button>
    </div>

    <div id="waiting">
        <h3>Waiting for game to start...</h3>
        <ul id="playersWaiting"></ul>
        <button id="leaveWaiting">Leave Lobby</button>
    </div>

    <div id="game">
        <h3>Game Started</h3>
        <p id="roleDisplay"></p>
        <button id="endGame">End Session</button>
    </div>

    <div id="loginHost" style="position:fixed;top:10px;right:10px">
        <input id="hostPass" type="password" placeholder="Host password" autocomplete="off" />
        <button id="hostLoginBtn">Host Login</button>
        <button id="startBtn" style="display:none">Start Game</button>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const BACKEND_URL = location.hostname === "localhost" ? "http://localhost:5001" : "https://imposter-backend-ch3h.onrender.com";
        const socket = io(BACKEND_URL);

        const loginDiv = document.getElementById("login");
        const lobbyDiv = document.getElementById("lobby");
        const waitingDiv = document.getElementById("waiting");
        const gameDiv = document.getElementById("game");
        const loginHostDiv = document.getElementById("loginHost");

        const nameInput = document.getElementById("name");
        const joinBtn = document.getElementById("join");
        const playersList = document.getElementById("players");
        const playersWaitingList = document.getElementById("playersWaiting");
        const leaveLobbyBtn = document.getElementById("leaveLobby");
        const leaveWaitingBtn = document.getElementById("leaveWaiting");
        const roleDisplay = document.getElementById("roleDisplay");

        const hostPassInput = document.getElementById("hostPass");
        const hostLoginBtn = document.getElementById("hostLoginBtn");
        const startBtn = document.getElementById("startBtn");

        const endGameBtn = document.getElementById("endGame");

        let playerId = localStorage.getItem("playerId") || null;
        let currentState = "login"; // login, lobby, waiting, game
        let isHost = false;
        isHost = localStorage.getItem("isHost") === "true";

        if (isHost && playerId) {
            socket.emit("reclaim_host", { playerId });
        }

        function setState(state) {
            currentState = state;
            loginDiv.style.display = state === "login" ? "block" : "none";
            lobbyDiv.style.display = state === "lobby" ? "block" : "none";
            waitingDiv.style.display = state === "waiting" ? "block" : "none";
            gameDiv.style.display = state === "game" ? "block" : "none";
        }

        function setJoinEnabled(enabled) {
            document.getElementById("loginMessage").textContent =
                enabled ? "Enter your name to join" : "Waiting for host…";
            nameInput.style.display = enabled ? "inline-block" : "none";
            joinBtn.style.display = enabled ? "inline-block" : "none";
        }

        function renderPlayers(players, container) {
            container.innerHTML = "";
            players.forEach(p => {
                const li = document.createElement("li");
                li.textContent = p.name + (p.player_id === playerId ? " (You)" : "");
                container.appendChild(li);
            });
        }

        function joinGame(name) {
            socket.emit("join", { name, playerId });
        }

        function leaveGame() {
            socket.emit("leave");
            localStorage.removeItem("playerId");
            playerId = null;
            setState("login");
            joinBtn.disabled = false;
            nameInput.value = "";
        }

        joinBtn.onclick = () => {
            if (currentState !== "login" || nameInput.style.display === "none") return;
            const name = nameInput.value.trim();
            if (!name) return;
            joinBtn.disabled = true;
            joinGame(name);
        };

        leaveLobbyBtn.onclick = leaveGame;
        leaveWaitingBtn.onclick = leaveGame;
        endGameBtn.onclick = () => {
            if (isHost) {
                socket.emit("end_session");
                localStorage.clear();
                location.reload();
            } else {
                leaveGame();
            }
        };

        hostLoginBtn.onclick = () => {
            socket.emit("host_login", { password: hostPassInput.value });
        };

        startBtn.onclick = () => {
            socket.emit("start_game");
        };

        socket.on("join_result", data => {
            if (data.success) {
                playerId = data.playerId;
                localStorage.setItem("playerId", playerId);
                if (data.state === "lobby") {
                    setState("lobby");
                    renderPlayers(data.players, playersList);
                } else if (data.state === "waiting") {
                    setState("waiting");
                    renderPlayers(data.players, playersWaitingList);
                } else if (data.state === "game") {
                    setState("game");
                    roleDisplay.textContent = "Your role: " + data.role;
                }
            } else {
                alert(data.message || "Failed to join");
                joinBtn.disabled = false;
            }
        });

        socket.on("players_update", data => {
            if (currentState === "lobby") {
                renderPlayers(data.players, playersList);
            } else if (currentState === "waiting") {
                renderPlayers(data.players, playersWaitingList);
            }
        });

        socket.on("game_started", () => {
            setState("game");
        });

        socket.on("role", data => {
            roleDisplay.textContent = "Your role: " + data.role;
        });

        socket.on("host_login_result", data => {
            if (data.success) {
                isHost = true;
                localStorage.setItem("isHost", "true");
                startBtn.style.display = "inline-block";
                alert("Logged in as host");
                loginHostDiv.style.display = "block";
                if (data.player_id) {
                    playerId = data.player_id;
                    localStorage.setItem("playerId", playerId);
                }
                socket.emit("request_state");
            } else {
                alert("Wrong password or host already exists");
            }
        });

        socket.on("state_update", data => {
            const state = data.state;

            if (state === "waiting") {
                setState("login");
                setJoinEnabled(false);
                loginHostDiv.style.display = "block";
            }

            if (state === "lobby") {
                setState("login");
                setJoinEnabled(true);
                loginHostDiv.style.display = isHost ? "block" : "none";
            }

            if (state === "game") {
                setState("game");
                loginHostDiv.style.display = "none";
                if (isHost) startBtn.style.display = "none";
            }
        });

        setState("login");
        if (playerId) {
            socket.emit("join", { playerId });
        }
    </script>
</body>
</html>